<?xml version='1.0' encoding='UTF-8' ?>
<rsm:CrossIndustryInvoice xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100" xmlns:qdt="urn:un:unece:uncefact:data:standard:QualifiedDataType:100" xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">
  <rsm:ExchangedDocumentContext>
   <ram:GuidelineSpecifiedDocumentContextParameter>
      <ram:ID>{% if profile == 'minimum' %}urn:factur-x.eu:1p0:minimum{% elif profile == 'basicwl' %}urn:factur-x.eu:1p0:basicwl{% elif profile == 'basic' %}urn:cen.eu:en16931:2017#compliant#urn:factur-x.eu:1p0:basic{% elif profile == 'extended' %}urn:cen.eu:en16931:2017#conformant#urn:factur-x.eu:1p0:extended{% else %}urn:cen.eu:en16931:2017{% endif %}</ram:ID>
    </ram:GuidelineSpecifiedDocumentContextParameter>
  </rsm:ExchangedDocumentContext>
  <rsm:ExchangedDocument>
    <ram:ID>{{ invoice_number }}</ram:ID>
    <ram:TypeCode>{{ document_type_code | default('380') }}</ram:TypeCode>
    <ram:IssueDateTime>
      <udt:DateTimeString format="102">{{ issue_date }}</udt:DateTimeString>
    </ram:IssueDateTime>
    {% for note in notes | default([]) %}
    <ram:IncludedNote>
      <ram:Content>{{ note }}</ram:Content>
    </ram:IncludedNote>
    {% endfor %}
  </rsm:ExchangedDocument>
  <rsm:SupplyChainTradeTransaction>
    {% for line in lines %}
    <ram:IncludedSupplyChainTradeLineItem>
        <ram:AssociatedDocumentLineDocument>
            <ram:LineID>{{ line.line_id }}</ram:LineID>
        </ram:AssociatedDocumentLineDocument>
        <ram:SpecifiedTradeProduct>
            <ram:Name>{{ line.name }}</ram:Name>
            {% if line.country_of_origin %}
            <ram:OriginTradeCountry>
              <ram:ID>{{ line.country_of_origin }}</ram:ID>
            </ram:OriginTradeCountry>
            {% endif %}
        </ram:SpecifiedTradeProduct>
        <ram:SpecifiedLineTradeAgreement>
            <ram:NetPriceProductTradePrice>
                <ram:ChargeAmount>{{ "%.2f"|format(line.net_price) }}</ram:ChargeAmount>
            </ram:NetPriceProductTradePrice>
        </ram:SpecifiedLineTradeAgreement>
        <ram:SpecifiedLineTradeDelivery>
            <ram:BilledQuantity unitCode="{{ line.unit_code }}">{{ line.quantity }}</ram:BilledQuantity>
        </ram:SpecifiedLineTradeDelivery>
        <ram:SpecifiedLineTradeSettlement>
            <ram:ApplicableTradeTax>
                <ram:TypeCode>VAT</ram:TypeCode>
                <ram:CategoryCode>{{ line.vat_category }}</ram:CategoryCode>
                <ram:RateApplicablePercent>{{ "%.2f"|format(line.vat_rate) }}</ram:RateApplicablePercent>
            </ram:ApplicableTradeTax>
            <ram:SpecifiedTradeSettlementLineMonetarySummation>
                <ram:LineTotalAmount>{{ "%.2f"|format(line.net_total) }}</ram:LineTotalAmount>
            </ram:SpecifiedTradeSettlementLineMonetarySummation>
        </ram:SpecifiedLineTradeSettlement>
    </ram:IncludedSupplyChainTradeLineItem>
    {% endfor %}
    <ram:ApplicableHeaderTradeAgreement>
      {% if buyer_reference %}
      <ram:BuyerReference>{{ buyer_reference }}</ram:BuyerReference>
      {% endif %}
      <ram:SellerTradeParty>
        <ram:Name>{{ seller.name }}</ram:Name>
        {% if seller.siret %}
        <ram:SpecifiedLegalOrganization>
             <ram:ID schemeID="0002">{{ seller.siret }}</ram:ID>
        </ram:SpecifiedLegalOrganization>
        {% endif %}
        <ram:PostalTradeAddress>
            {% if seller.address %}
            {% if seller.address.postcode %}<ram:PostcodeCode>{{ seller.address.postcode }}</ram:PostcodeCode>{% endif %}
            <ram:LineOne>{{ seller.address.line1 or 'Street' }}</ram:LineOne>
            {% if seller.address.line2 %}<ram:LineTwo>{{ seller.address.line2 }}</ram:LineTwo>{% endif %}
            <ram:CityName>{{ seller.address.city or 'City' }}</ram:CityName>
            <ram:CountryID>{{ seller.address.country_code or seller.country_code or 'FR' }}</ram:CountryID>
            {% else %}
            <ram:CountryID>{{ seller.country_code or 'FR' }}</ram:CountryID>
            {% endif %}
        </ram:PostalTradeAddress>
        {% if seller.vat_number %}
        <ram:SpecifiedTaxRegistration>
          <ram:ID schemeID="VA">{{ seller.vat_number }}</ram:ID>
        </ram:SpecifiedTaxRegistration>
        {% endif %}
        {% if seller.tax_number %}
        <ram:SpecifiedTaxRegistration>
          <ram:ID schemeID="FC">{{ seller.tax_number }}</ram:ID>
        </ram:SpecifiedTaxRegistration>
        {% endif %}
      </ram:SellerTradeParty>
      <ram:BuyerTradeParty>
        <ram:Name>{{ buyer.name }}</ram:Name>
        {% if buyer.address %}
        <ram:PostalTradeAddress>
            {% if buyer.address.postcode %}<ram:PostcodeCode>{{ buyer.address.postcode }}</ram:PostcodeCode>{% endif %}
            <ram:LineOne>{{ buyer.address.line1 or 'Street' }}</ram:LineOne>
            <ram:CityName>{{ buyer.address.city or 'City' }}</ram:CityName>
            <ram:CountryID>{{ buyer.address.country_code or 'FR' }}</ram:CountryID>
        </ram:PostalTradeAddress>
        {% endif %}
      </ram:BuyerTradeParty>
    </ram:ApplicableHeaderTradeAgreement>
    <ram:ApplicableHeaderTradeDelivery>
      {% if delivery_date %}
      <ram:ActualDeliverySupplyChainEvent>
        <ram:OccurrenceDateTime>
          <udt:DateTimeString format="102">{{ delivery_date }}</udt:DateTimeString>
        </ram:OccurrenceDateTime>
      </ram:ActualDeliverySupplyChainEvent>
      {% endif %}
    </ram:ApplicableHeaderTradeDelivery>
    <ram:ApplicableHeaderTradeSettlement>
      <ram:InvoiceCurrencyCode>{{ currency_code | default('EUR') }}</ram:InvoiceCurrencyCode>
      {% if seller.iban or payment_means_code %}
      <ram:SpecifiedTradeSettlementPaymentMeans>
        <ram:TypeCode>{{ payment_means_code | default('58') }}</ram:TypeCode>
        {% if seller.iban %}
        <ram:PayeePartyCreditorFinancialAccount>
          <ram:IBANID>{{ seller.iban }}</ram:IBANID>
          {% if seller.bank_name %}<ram:AccountName>{{ seller.bank_name }}</ram:AccountName>{% endif %}
        </ram:PayeePartyCreditorFinancialAccount>
        {% if seller.bic %}
        <ram:PayeeSpecifiedCreditorFinancialInstitution>
          <ram:BICID>{{ seller.bic }}</ram:BICID>
        </ram:PayeeSpecifiedCreditorFinancialInstitution>
        {% endif %}
        {% endif %}
      </ram:SpecifiedTradeSettlementPaymentMeans>
      {% endif %}
      {% for tax in tax_details %}
      <ram:ApplicableTradeTax>
            <ram:CalculatedAmount>{{ tax.calculated_amount }}</ram:CalculatedAmount>
            <ram:TypeCode>VAT</ram:TypeCode>
            <ram:BasisAmount>{{ tax.basis_amount }}</ram:BasisAmount>
            <ram:CategoryCode>{{ tax.category_code }}</ram:CategoryCode>
            <ram:RateApplicablePercent>{{ tax.rate }}</ram:RateApplicablePercent>
      </ram:ApplicableTradeTax>
      {% endfor %}
      {% if due_date or payment_terms or payment_discount %}
      <ram:SpecifiedTradePaymentTerms>
        {% if payment_terms %}<ram:Description>{{ payment_terms }}</ram:Description>{% endif %}
        {% if due_date %}
        <ram:DueDateDateTime>
            <udt:DateTimeString format="102">{{ due_date }}</udt:DateTimeString>
        </ram:DueDateDateTime>
        {% endif %}
        {% if payment_discount %}
        <ram:ApplicableTradePaymentDiscountTerms>
          <ram:BasisPeriodMeasure unitCode="DAY">{{ payment_discount.days }}</ram:BasisPeriodMeasure>
          <ram:CalculationPercent>{{ payment_discount.percent }}</ram:CalculationPercent>
        </ram:ApplicableTradePaymentDiscountTerms>
        {% endif %}
      </ram:SpecifiedTradePaymentTerms>
      {% endif %}
      <ram:SpecifiedTradeSettlementHeaderMonetarySummation>
        {% if profile != 'minimum' %}<ram:LineTotalAmount>{{ amounts.tax_basis_total }}</ram:LineTotalAmount>{% endif %}
        <ram:TaxBasisTotalAmount>{{ amounts.tax_basis_total }}</ram:TaxBasisTotalAmount>
        <ram:TaxTotalAmount currencyID="{{ currency_code | default('EUR') }}">{{ amounts.tax_total }}</ram:TaxTotalAmount>
        <ram:GrandTotalAmount>{{ amounts.grand_total }}</ram:GrandTotalAmount>
		<ram:DuePayableAmount>{{ amounts.due_payable }}</ram:DuePayableAmount>
      </ram:SpecifiedTradeSettlementHeaderMonetarySummation>
    </ram:ApplicableHeaderTradeSettlement>
  </rsm:SupplyChainTradeTransaction>
</rsm:CrossIndustryInvoice>
