name: Security Scan, Build & Release (EU Compliance)

# ðŸ›‘ CRITICAL BUILD POLICY ðŸ›‘
# THIS WORKFLOW IS FOR **COMMUNITY EDITION** ONLY.
# NEVER ADD THE 'PRO' BUILD TARGET HERE.
#
# REGLE ABSOLUE : La version PRO contient des secrets et ne doit JAMAIS
# Ãªtre construite sur GitHub Actions (Cloud).
# Elle doit Ãªtre construite LOCALEMENT via `.\publish_release.ps1`
#
# Voir CONTEXT_FOR_AI.md Section "Deployment Procedures"

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'DOCKER_HUB_README.md'
      - 'docs/**'
      - '_INTERNAL/**'
      - 'examples/**'
  schedule:
    - cron: '0 0 * * *'  # DAILY Scan (Required for EU Cyber Resilience Act responsiveness)
  workflow_dispatch:      # Manual trigger for releases

jobs:
  security-compliance:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # To create releases
      packages: write     # If pushing to GHCR later
      # id-token: write   # Uncomment for OIDC/Cosign signing

    steps:
      - uses: actions/checkout@v3

      # ------------------------------------------------------------------
      # PHASE 1: PRE-BUILD SECURITY (Supply Chain Defense)
      # ------------------------------------------------------------------
      
      # [P2] Scan Base Image to avoid inheriting upstream vulnerabilities
      - name: Scan Base Image (Python 3.11)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'python:3.11-slim'
          format: 'table'
          exit-code: '0' # Don't fail pipeline on base image, we fix it in Dockerfile
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      # ------------------------------------------------------------------
      # PHASE 2: BUILD & IDENTIFY
      # ------------------------------------------------------------------

      - name: Set Version
        run: echo "VERSION=$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build Docker Image (Community Security Check)
        run: docker build -t facturx-engine:${{ env.VERSION }} -t facturx-engine:latest .

      # [P0] Generate SBOM (Software Bill of Materials) - LEGALLY REQUIRED 2026
      # This proves what is inside your black box.
      - name: Generate SBOM (CycloneDX)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'facturx-engine:${{ env.VERSION }}'
          format: 'cyclonedx'
          output: 'sbom-${{ env.VERSION }}.json'
          exit-code: '0' # Don't fail on SBOM gen
          
      # [P0] Scan Final Image for Vulnerabilities
      - name: Scan Final Image (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'facturx-engine:${{ env.VERSION }}'
          format: 'table'
          exit-code: '0' # Informative only (for now) to avoid blocking release
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
      
      - name: Show Trivia Scan Results (On Failure)
        if: failure()
        run: cat trivy-results.txt || echo "No results file found, check logs above."

      # ------------------------------------------------------------------
      # PHASE 3: PACKAGE & NOTIFY
      # ------------------------------------------------------------------

      - name: Export Versioned Artifact
        if: success()
        run: |
          docker save facturx-engine:${{ env.VERSION }} | gzip > facturx-engine-pro-${{ env.VERSION }}.tar.gz
          SHA256=$(sha256sum facturx-engine-pro-${{ env.VERSION }}.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_ENV
          echo "Artifact SHA256: ${SHA256}"

      # [P1] Notification (Skeleton - Requires Secrets)
      - name: Notify Failure (Slack/Email)
        if: failure()
        run: |
          echo "::error::ðŸš¨ SECURITY SCAN FAILED! Immediate action required."
          # To enable Slack notifications:
          # 1. Add SLACK_WEBHOOK to repo secrets
          # 2. Uncomment 'uses: slackapi/slack-github-action@v1' block

      # ------------------------------------------------------------------
      # PHASE 4: RELEASE (If Manual Trigger + Success)
      # ------------------------------------------------------------------

      # [P2] Internal Artifact Upload (For Lemon Squeezy Admin)
      # We do NOT create a public Release here because this contains PRO code.
      - name: Upload Pro Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: facturx-engine-pro-build
          path: |
            facturx-engine-pro-${{ env.VERSION }}.tar.gz
            sbom-${{ env.VERSION }}.json
          retention-days: 5
